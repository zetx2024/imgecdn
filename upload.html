<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDN Uploader</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .upload-card { background: #1e293b; padding: 2rem; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); width: 400px; text-align: center; }
        input[type="file"] { margin: 20px 0; border: 2px dashed #334155; padding: 20px; width: 80%; border-radius: 8px; cursor: pointer; }
        button { background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; }
        button:disabled { background: #475569; }
        #result { margin-top: 20px; word-break: break-all; font-size: 0.9rem; padding: 10px; background: #0f172a; border-radius: 4px; display: none; }
        .copy-btn { background: #10b981; margin-top: 10px; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="upload-card">
    <h2>CDN Asset Uploader</h2>
    <input type="password" id="token" placeholder="Enter GitHub Token" style="width: 90%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: none;">
    <input type="file" id="fileInput">
    <button id="uploadBtn">Upload to Storage</button>
    
    <div id="result">
        <p>Uploaded Successfully!</p>
        <code id="urlText"></code>
        <button class="copy-btn" onclick="copyUrl()">Copy URL</button>
    </div>
</div>

<script>
    const GITHUB_USER = "YOUR_GITHUB_USERNAME";
    const REPO_NAME = "imgecdn";
    const FOLDER = "storage";
    const CDN_DOMAIN = "cdn1.yrjmail.com";

    document.getElementById('uploadBtn').addEventListener('click', async () => {
        const fileInput = document.getElementById('fileInput');
        const token = document.getElementById('token').value;
        const btn = document.getElementById('uploadBtn');

        if (!fileInput.files[0] || !token) return alert("Select file and enter token!");

        btn.disabled = true;
        btn.innerText = "Processing...";

        try {
            const file = fileInput.files[0];
            const ext = file.name.split('.').pop();

            // 1. Fetch folder content to find the next number
            const listRes = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO_NAME}/contents/${FOLDER}`, {
                headers: { 'Authorization': `token ${token}` }
            });
            
            const files = await listRes.json();
            let nextNumber = 1;

            if (Array.isArray(files)) {
                const numbers = files
                    .map(f => parseInt(f.name.split('.')[0]))
                    .filter(n => !isNaN(n));
                if (numbers.length > 0) nextNumber = Math.max(...numbers) + 1;
            }

            const newFileName = `${nextNumber}.${ext}`;
            const reader = new FileReader();

            reader.onload = async () => {
                const base64Content = reader.result.split(',')[1];

                // 2. Upload to GitHub via API
                const uploadRes = await fetch(`https://api.github.com/repos/${GITHUB_USER}/${REPO_NAME}/contents/${FOLDER}/${newFileName}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Upload ${newFileName}`,
                        content: base64Content
                    })
                });

                if (uploadRes.ok) {
                    const finalUrl = `https://${CDN_DOMAIN}/${FOLDER}/${newFileName}`;
                    document.getElementById('urlText').innerText = finalUrl;
                    document.getElementById('result').style.display = 'block';
                } else {
                    alert("Upload failed. Check token permissions.");
                }
                btn.disabled = false;
                btn.innerText = "Upload to Storage";
            };

            reader.readAsDataURL(file);

        } catch (err) {
            console.error(err);
            alert("Error occurred. Check console.");
            btn.disabled = false;
        }
    });

    function copyUrl() {
        const text = document.getElementById('urlText').innerText;
        navigator.clipboard.writeText(text);
        alert("Link copied!");
    }
</script>

</body>
</html>
